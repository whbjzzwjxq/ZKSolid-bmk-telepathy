pragma solidity 0.8.14;
pragma experimental ABIEncoderV2;

import "curve-merkle-oracle/MerklePatriciaProofVerifier.sol";
import "curve-merkle-oracle/StateProofVerifier.sol";
import "forge-std/Test.sol";
import "forge-std/console.sol";
import "Solidity-RLP/RLPReader.sol";
import "../../src/amb/libraries/MerklePatriciaTrie.sol";

contract MerklePatriciaTest is Test {
	using RLPReader for bytes;
	using RLPReader for RLPReader.RLPItem;
	using RLPReader for RLPReader.Iterator;

	function setUp() public {}

	function testAccountProofOther() public view {
		// 12761698 ropsten.json slot number
		address contractAddress = 0x594bA7f22a52f58ba64a6093A2FC2e004b23A7BE;
		bytes32 addressHash = keccak256(abi.encodePacked(contractAddress));
		bytes32 stateRootHash = bytes32(0x1e1bd10bda86dc06b5704afd26df271d80071b7fe385e6d9107f10c8a6998898);
		bytes[] memory _proof = new bytes[](8);
		_proof[0] = hex"f90211a061e4915040960a5caba3ba34c71ee1cd6246025f716dc830b76938510231947ba08d1388b6665a61f8e22048042c4971dfc5fb15616dfe5b3e861d4341dd9ba06ca05cb9358e68d13badc5797470b418418b09a40a473aa222b87406d45b97528651a038f4ee954f6b79b9923d7934b9312c892622829481f1a613528f33ac1ba35ab5a007dc3b73232d1bd092ebdb54e127115fea93f405cf855f3eda83c838d0984feba080799e3ea519a7ccb0003242ea7b6ed3b3b2d8a43cf8150870238c452236e312a0613366cb2ba78e13b3f5af2f3330cf8609b454890332a7116a2c7edf210a1a66a06383dce0b38dfe74744deb322f694725e4c3d9168b80b106c7b58f205c3810b3a03b40a8e9d01bdafa0884f8d8e77eabdb96eb29d400c63a20eeec8e5417fece5fa08dae6ae2dda6ae7a597320e452827cecbdbca83295813f9f0e3277cad5588109a0d1cb0d29d1133687e0c94dc464fa395729f585a976b1904a2b67c690941ab9c0a0e4698914a7fc1008bf2420e71113198b402ce47a6b03afad219d676354d4ea5ba07f64bdc7861fe27a9e93641f6350cad83ff5bd1f2734a7fa39dce768259ffa25a03d6c7959009086f025017ac53bd255c21a37a1518add912fd6e46931d666bef0a0cd49504a1899af46d782b900b004a61ba7e282e96595570f08f988c935b09136a0860509ddb51d1fd215f950d22f29d584b484294c84ec621ddd0702fc61c21de180";
		_proof[1] = hex"f90211a06ea036715b3b940c58e0428a586f1963d8742a53df2a1148d0b9f064c235ae9aa0a7b4a63fb349ab1f190163fa4e8bdbf73fe8ed93e21f66535d7aa2db1b0009eba05f24da5f455f2952aedcf3fa47e2bec3a84407dff456df20847a21b5bec4f516a037e6467aece52f98d9ba9a5c6022e61ce69b06b0e7eb3565cc0cbaa898f034fda0284f6d57390a306d3af44df2b76c64a36d4fa7778c6c3ddbb6bbc5962d1f5240a065973d20c68907db64b2925a54c5d9d9d03b317a036b7ba7e9be29d95a190390a0ce88edcbae2a047f0a71262f674494d515f1f169f1ab2cb553f769b48956ae8ca0794d3b534babb32db120ba78865e7520038a06bd3e187ce1f1f2f77d9fe4bc5ba004b5b8893830fad80317502ddf99e10a2e3a2b90144351e674863f8ac0b8c0c3a0c5b2f468cbc0fce16e8075395dd87887c83f441a4c9ffcef8812de91dd14a621a0d677c79687f324fcc15e3b4d4005d1da7c6d9cb718b216a3dca2210816a30927a0d9deac0c4d31867f660fb68ad0890ea0cbdd5ed5a296c7360b3a9b220eadd90aa086cf39c1b3cc722d238ae9352272b187b51653c6138e7c5a8fc76ebf5c1ba737a00e48b533577fda39f447e07b2822d55713270bc035a135b8b059cae570349fbfa01fde554cda585532f5439e4c899fcb44ff1b8bed38c0cb3ed59cf8a92675f423a0bae59fcadeb2c11aeb0f460abbe4f6ad7126624e6e12a88f11198169ef1a010280";
		_proof[2] = hex"f90211a000f10c5e27fe30e081d2d8d21b1dc483c5e9731dd129019330afeea31bf3027ca08b4d3a600ecec9bd33738b9b3052d0cadb54cb0546499b9544b561699b0c3a95a021b8c364368e4047f3fd0ce9c0363eca9fa4b5c5d764f46b1dc4526ef9d91c20a0836a7cb1966221b3afe09f8dc5588afaffa5aced3c719de22d1ddd1ab2e5205aa05aa9f86efc7db6437c2c6373bb3a82a763e81d8b38140ec01bcaeb3b6cce52cca06f491f342646255cfe986c8c4b37fa9abedfed4192d4b402ed60b73b0c73c3aea07a8551ef240f9de41be2267e25f5b9d196ab3abef04661f78badd2debe34dcb9a0053d0f3ff22b8cdfc3cbf2eea12e2ff03fb21a6c9cf17f40c1b12214343db475a024ff57e515fea8dd26b54e0ba7eaafd2fd748e3c24936b152feb95b8dfb53251a03f7192f82b50b450c1f3ff6e0995e156f59241ea527a0f1375fa421b84b26561a06b10045198f037f1b78056a7f067f96ce2fba69de707d7e4455e30ecccea0729a020fb4b7031c139eeedef0a236cf688df5c427d00009f91e2ca5d66a561ea72c2a09e30ea1775458ba4492065f2a67a31622b8ec0e4f139ada3324e0c3371486994a0c4a2c811183d57f3e5cb21f024fce132cb6420ff0c9b2479a5ef91ac30c70805a09245df63db40bd648e0e1d0de3689486013b2e675c46ec876b5eca5e528fdb01a0103d79f816b0ce0d984589f5872038fa815a2f6a8c2fc7be3b621b9716be96a780";
		_proof[3] = hex"f90211a07d7d1e5c43dbe9a9bbe17d1caa370ee05bca8f34ef2e5d8c1e80a289401dce7aa099e495a1bce0b31d0496895e7f530b305e000ab810bf2f321ca964df3019babba031f5e5b18513571e4203dbadcf7d95e9f79eea40e2fd702d05c528dd92a8124fa07d11620d9e2a30cf61395f3048521404e37507e15fa98088853d4a0242370e86a028859efc98146eccd4a942099effc7f8c1928c2a11faac58939fe8d5c8aaf8a5a04fa32eed0b0343a00c7c65d177522cd1517da1b942545f2412bf99316905323aa066b2108fccb523836bf11f43f225acf383465b8f15e97b749a1e6ef048cc0b75a0c318af0786f6c4f098143c47c80a4030233ed0550bb8e84d2839c0a9c9335e03a0f3ca853a8d8a6c6248d7057204f0aa7af0de3b51de57b9cfe95876356fd8ba65a000eb11fd5ff40881627a5f6e3f80e2bd30256eda3fccf0136b644545dbc090b1a05835c476fac516570da884b65486db46017d59936c17239ef3540852470c2c13a02cf99702c880729f227b283291cb64d1b9b34a82041c5365d5fdb0c53578292aa06d082ebaf6b5d4d037a69f238152c022d74a6c47448aa5f7b53314dbedbb6b19a0b91615f35b9ebb8f443f3c5f526e0050d4605c21f2e5cd81922fa5e95d284dc3a0d44525e1f26e5ed38670bea83755b60c11f977b885d4c877387f94997c97b30fa0779b327a0b6fc4827eff68d5d4dd977f82d998ab19a34f1a0926f625996da47880";
		_proof[4] = hex"f90211a09925b76a16d98586e04941406a932190adda9cc6829629919a6f017af95fc60ea0a28bf9ac2fb2ca04e101979e2f5e96fbfc0f1ee2d263b00dea251d807f2ff790a0f04374728b7db397f63ae1c61e23659ba98530045a25c0eef2712e85d1b9432ea0aa618a5c24071fed324db74402b446c71c1a08b76419724acdc2aa8cabe2c126a0d5b3bf201bd34985015d13ab1ec5026583985935d0258824ed136db32d0d9305a028561432ee8a351969d3661b4bffb880892a35c3acf81f664f05fb4ce48a5628a07496029b042d3deaec0d18230fd5aced3a113329c1bba09c1f7108f6e7340db2a04286cb4bb0809aba549400ca3a39bb3791d872cb2349823c85043cfac01ccce3a084a0633e114bbe2e66e919026c0278bf7dbeedf9c560d4f270d17b4553ddaccfa03c320610d77338881732e6d870b6e3e48845da4d276fa1ac8fc572ff6ec138efa080e64709b5c42e8a1d468cfe822262056dd0aa73f2129990e6c0a0b31e57e5eda04fa919ae046ac7a740b5b30329a591b04143e2aa278b9a5a020f52cc14c0957ca010cfea4315620fbefa34105f148401da2b7124bc972d11cc885c3ee5bccd7762a02947144e0f220475b9c636bfbec4ad3eb719174f61d76bdd18816c82999d9165a071c4eeaa0505963f35ce7b670e55da22aa96e3910faa3cfc1358f2e8e78f6873a03f8b551680771ee28329253ba3de9100f0a2454502559000051bae37e2dfd36a80";
		_proof[5] = hex"f901f1a0c08ef8d5b88929e0c9aa960edae6ef1d73f18edad36d212861015fa3612897b2a08c379117765a1ab9851d6f572bd3672ea7691e5471e95ea54107dbbd1d7affe0a039bf8fb1faeebec1770d96d782b584246aa8b56abad54321a626252b04dfc1bba0f51daf5e60e8eb5362123bac917dd1fa4ca73696ff82efd6c499db1f59441ba4a083141291d6516095d3097416ae140f8759971c45e23cca49e3638f5f9c174233a0be89a5d7160906f23ad305c3596f4ab98cfd806efff5f2f85fbdc99d1d118211a0c0f37de4c75b2641a63db6d2fe8204ad103a44b63ba614490c673e60e30cda96a0ad7a49f4d7e3509a359157e42c4238e19d2c4dee7d5dc78c13dd23a8a8c53b3d80a0a170a7eaa23a1affb9ac93cd36e25bc82c3115247a6b85218262e75fcb8d8384a0e14231b6dcdc5be6af060ff1b9b7293c6ceb9ff056407b243fc2cfd29f2b0335a043a52c308fc24f490c5c405e518595c734b140a9737df4ad8176c13b30a505e2a04343025a067e12ba0c7d1af65cc7405af3139f7c3d81a32beb846191195c2defa0e513f7ffea8f703f5a982637bc1f37351c60f9d0ef025024d475592a8968f958a04a79ac0f0bc198ca431da041cc1d457ac2643d2c78ca9fbbbcdf458645a93b6da0c4be3d90016d6bdd1ae33af9beec641d257bb9deaf3c77b6337cdc76f5a6ef1180";
		_proof[6] = hex"f891808080a0bb35f3090f671ad51fa42325ea445891d10ceb4ed53c5364cbb173017435ffa780a0ebadc7f168d8343383d07d2ec6f9c8fb6c1af23d6493bc7081d165c1d04970e280a0df98e7b570759442a0ae3af93a33d901fcb0c491781d993c079df8c599a4a65980808080808080a024e47c7b5ece7a9afbb64bd1c466285fe7d1fa50bae9326fbb22ced0637f570680";
		_proof[7] = hex"f8669d38e910ed8df3e2c058bed6f4fc4218ba17cb2db5170708067c11995321b846f8440180a08cccc66b89addd7131562996d3b2fff89ce775e940e44a3618cbdf62389549d3a0add804b4a1208bbc99f66d37e5917a1e9c01d95e10ade06ac19d07a535ea42ce";

		RLPReader.RLPItem[] memory accountProof = new RLPReader.RLPItem[](8);
		for (uint256 i = 0; i < 8; i++) {
			accountProof[i] = RLPReader.toRlpItem(_proof[i]);
		}

		StateProofVerifier.Account memory account = StateProofVerifier.extractAccountFromProof(
			addressHash,
			stateRootHash,
			accountProof
		);
		require(account.exists, "Account does not exist");
		require(account.storageRoot == 0x8cccc66b89addd7131562996d3b2fff89ce775e940e44a3618cbdf62389549d3);
		bytes32 storageRoot = MPT.verifyAccount(
			_proof,
			address(0x594bA7f22a52f58ba64a6093A2FC2e004b23A7BE),
			stateRootHash
		);
		require(storageRoot == 0x8cccc66b89addd7131562996d3b2fff89ce775e940e44a3618cbdf62389549d3);
	}

	function testStorageProofOther() public view {
		bytes32 nullifier = 0x255a4e7e2aa56df6431471a9ced591a640ee61a26c689d03eb45be19173462c2;
		bytes32 slotHash = keccak256(abi.encodePacked(keccak256(abi.encode(nullifier, 5))));
		// this is the 'storageProof.key' in ropsten.json
		// require(slotHash == 0x957c8e4b9d0de4887913721ebe178b11d1ac696418b167d2d85f33a7bf15a3c5);
		bytes32 storageRoot = 0x8cccc66b89addd7131562996d3b2fff89ce775e940e44a3618cbdf62389549d3;
		bytes[] memory _storageProof = new bytes[](2);
		_storageProof[0] = hex"f9013180a09b7a8a67b359c71098112cb2f1b88c5eff3e46fcc78bd4deafdf118fde5d811080a0f2218727a7da5f8c9c541dd0f01c322e9ae2defc310161b9fa805699c4ae58dea0bcb99c351b48a3fa5638e463714abdb93ed7173bb7dfa2d1ca7962ace3f79b7f8080a02a93544d0134e09d38e5142e6273f75c0783fefbbd168ef08d1561b28d82d3d8a06613e4e9b680fc1f08d33e4c07f0253fc20acaf4ccf8ad58605d8648647293998080a0f0a6b6dfff4f09073880523d40d605f51c4bd1620e648c9ce04ab1dd903edb10a03411b5d0d9f4e575a778e9e90f4782721a8240b10fae673ffa5bf15a93d703ef80a0ba51b046a42225d6a66adf96e039fd3ed86ae3296bfcb2eb473aa4741c6ba6a2a00dc5f82b3c6be9676c0e6208ac683339905783c4d21466aa102897b9591bd91480";
		_storageProof[1] = hex"e2a0363f7dda5876b98836c4e92fd366c444b99226abbe5381dd9a78804177fdc35201";
		RLPReader.RLPItem[] memory storageProof = new RLPReader.RLPItem[](2);
		for (uint256 i = 0; i < 2; i++) {
			storageProof[i] = RLPReader.toRlpItem(_storageProof[i]);
		}
		StateProofVerifier.SlotValue memory slotValue = StateProofVerifier.extractSlotValueFromProof(
			slotHash,
			storageRoot,
			storageProof
		);
		require(slotValue.exists, "slot value does not exist");
		require(slotValue.value == 1, "slot value is not 1");
	}

	function testAccountProof() public view {
		address contractAddress = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
		bytes32 addressHash = keccak256(abi.encodePacked(contractAddress));
		bytes32 stateRootHash = bytes32(0xcf033b7a50b6eb55f2dd6ea57af174e8ae610ae771d16134224ea075a4af5794);

		bytes[] memory _proof = new bytes[](8);
		_proof[0] = hex"f90211a075df94991a16b9ade7f2170c499ae8affdd299122febfcc9c65e4049243c1664a050a8591385b3df93c49b045b3b70e2c9f8d81fa28473b7b85f472c59ef0e8ad6a0949da6622fbb7b0d40774f2cfab6c9696f2182f5d8818e1e3ee3ed1ab950d03ca02b606dca80573cb16777e977c0ab2205b592bd74a3d8aac28bcb9af8ef6ad2b8a058ad63d9908b1cbf51a320699711faf5b538e1e604409ae9e91bf88b3b0217eca040ee113c0b7fb3cfe87ce89aad2d76387a6c16832bdb65ef56282ac16846a664a0fae56ce47524274d84cfba67ab29a4219bbd308890a86cca673c94efdad4be75a0444c26545bc35170cb298b88e6d65e4c37f56783b0a92a4b895510db05c71d79a03c8fc1fd30f6d4cd018f209226ef812a52e3b7403e3801a96b3b4baf55e80e97a03c746ee503e6f45c15c5d47754cd0300dd69ef43994a7dc5e9b755c6d67b73f9a08ccdebbbf66edc9708552508f653546cfc84f5acfff84604c2bc16c55142d9eaa086c2851befe85d83c945bbbefdbe7e99cebe384b4e6f41b5b525be2d7e05978aa0ba1d4c0fe21f0ac8d1c4527d8c40179597be19942b622eaec3e6cdb5adeb48d4a008b2478c52fa11ef2494c5f19473d31cab8a8ab27f59fb379ed9950f6c96e443a0bb7faaaa6553b8921813d932db1cf9438bd539a9249b26d9d277d5e00bd12bbda01f3cb8598285038b0adf201ac1fa7ba5633bc278bb6d3b7d9256c746caef703d80";
		_proof[1] = hex"f90211a0e7c90c6856e72fa6da657ad176df29a30a5538d344c1e15471114c25ec168077a0f55d0cd01d5fb6bde408abe3b290a099d421934e8ab9805dd286f0904f8c767fa0c10f5e0ff12ec0d88442ba03e74894d96cbb99745cd0540c00d42062f5610d88a0157c966095fb8a2eaf54287035b69c600d940d95435fc6f5f1a19f62fb7f9e1da0b36c86272214ed317be7e9d7b1a55847ca34e9a7fe8b631aeef06ab8a1efcf08a0329bc7dc37b00f66ad8c387564a07caab88b814f183b654867bfcce3437e4539a069817b7fd6a9726e2317c549ea42624389a8398fd969a0924003c7ca18391452a02522b2cbc047e86b4645354d2390961e304f346e8dc89b7bc88cf070ba6c13c3a04e42be7c16a5188c76f80db0a8c60b15fc8eee16984768a126c462565b3916c4a0c71438dc34644870eab7e1c638e8598d991cf3bbe38a8e03f476f3836ac9c5f4a06a43be8e543bfb76ec967756e85a672ed7586fdf6327738c18c85ad96316332ca063c8f5265af6258c476cb069a746d1561e3ed86063f6f30e1d11892ad26f9ccea0d2e3e2be959b470ab930c1cfc662d73e72bc1248937e51c1a3cf8f0ffbe9962aa0e7791f337f419736d8094d764fccc5d14971d1290967dddc5813d9cd10f7c88da0da50f65370cdf922bb29a194658e4440a7e7828378b1700203d19388c5208397a0b398345731740c0dd491e4e61cf2e5d80b81b08811b210855cfc32c912b0f42780";
		_proof[2] = hex"f90211a0bad6b9ef159779de026028a12a88d4bcba27ea25dcf112756b08b1599282411ea0d4ed29c1bc7ef616a5b98c05dee6bd710e2fa5d87e0c5b29a7505a600309ceeea08fcbd45c3be9af55b3e67b3716607c3c29427424b6a61021f96c5aada9cd8dd2a092dcfaf4850dd2c34b71ac67b7d611c9eae1b6997228bb41aa278afee721f325a024b9081e358276b87770c1e3412230dc236b9d3003eefef0058d4178d48d2bd4a097fc64419f667fc334cc739766c9f72ab90e9646c48f4eebb67221beb993e81fa08fac3e0f4aa75e8de356f293a343ab1cf9acf0678a2b2a960ed797cb1f10b46aa090d259711b7cfc9456ba36bb33a917b7197a4c858dca700b7d29c54bb45bd01fa0b8f3d7da5a0836c1800a07484b39348a089f4ab0a7bca5f01d67f503ad16510aa0c3eb3895b83093e48ea72cb9fbb36d6738ad9759b4b93b8955bd2d8aeee8be80a0ab5a5e109f20916be00ae92d8bba289d53737096bf2f69cf3d7184c3f6b3e719a035011463947cff5e6441d553fae14bad9cdaf056ebbf5372eb01e9881361bc1ba04e106a258a75df772a31a3ae8e539180c92ac4afcb20e78e8baed6461b6b6376a0cf819c7ab190beb50a28cdf1bee8751c5fa849a7d2bdd64a103c8d14a6baaafaa0ba3678ca1c48824a81454b7aeb48ca8434d73bda04c9fd1f3dce96bec5c360dba06074c4137f9b05c02ed5cb9d98380a137f4a53adf758e44c3dc372e6d821b1c180";
		_proof[3] = hex"f90211a0b1dca59e81e50defc2cbac843e4f90ca3d49bd7367b6b78af831f93bc95c6fbba0b41e3c42df99db7757cc92b740bc30b9635ee9eb3bbf93f08d3457fbb8ece53ca00a8c153280b9dcbf87bede832033c2adbcc523244d5fa86d9a5b9d61a99604cca0d8951510149bf6310c6ff923348ba9fc25929b495448794219f124be3761a474a0daed6f405b0a440d687e246e829de7bc466c3e1f7e5f4ad8cbf11d07f0b0cfa4a0d5575ab25e2de555e797d620b5b74d04da86125e5ffb5fa4e0c0e6cc75c0892ca08a43ab5dbc83a0a3dc51871585aab302af92856971e338569e649d408667e40fa0f638bea7383055d803ae5f4e9c3f3943446947f51d9e0d45d1959e3b7c71963aa0c51fe161a4ce163fbeace7ec03d11e92f7a8aa00c1ea6040b5eb453f755be17ca0a00de2f7e8246065b17125f02e29b569f41806261d97a41778170beb3d1dfe10a0c82566050cd1c99f9ace05ddebfb91782168936c102ad7817351df1f29bf591ba069fa780081e05e78c66e04159fb404040f26d8de42cabdbb981455e1a3ea9c8ea01ddb09edfc4707dd13c3e1afbeda97af77b6f480a8df9efb3d82504222176afea0950e3c316690fd760008f607338481650d5ba7992c4775e46f62eb8914859ceda04b6659e9f95bd4a068515a1ee1a07d6c7221f9c108454efd4750ebead3d5750da02a560e069968f14cca041fc7112b9709a7501192af62892ce00085dbb0af52da80";
		_proof[4] = hex"f90211a0462b569dae1ff619e06485f8139ad271953d298d16cdc75b8b48b872fab0073fa05ee382f624b10764596080daf8894d7c023d6b7cf2d3c5ee3b1f861e20c7b553a074b146e945b46b759269398f276cc8ab3c3b2013116c400a867c149857e165bba053906c426edbe2d5aec14a593b1f25fe5fbb06f9ca42403faa01a236f34a4230a055421e2093a8d96d11c08250a2089592f8d35c4b29f44e6bc796bdf9e93875b2a03619289ede58031681942591bd92c38207e24e0c62b3f3429332b05953c20f8ba0192add4300472a48677b46d40ef482cba243f290753a2d3b2af5d4f1680bd769a0d4f6381a8acec06ff990cd764160c3c80eb66deb00b9114288ae5352c8b204f2a010faac292145be938f77508676083c28b5b9204eb5c4ed67f4ef3e06b4f8c51ca064f55a6f8b19cca171e38af0bca958dcb3ef630d8ff762f583439a6afdbb5952a0d43cc343e25ab5609e1813ea01e9c7b9b1f1bed84ad3b2bd467f8e4cdc7de39ea0c6a14ce757527bff43622431918eecd6c87319f9e6ac3b7d6ff771a11cb4a1f2a04ed4b035e4e62c1067114744e7bebf8937c08a1dd60f32b011cca2ae1b72241ea0df28c5a342603c58128fe4854e4f81c404b943388a88aa76d4374e442a3a5c48a09b686999c06c242418d923343e1437449a1b21e2883b16feed08508d9f13697ca0dc6db2db829c5ce5785f497fc2efb50635b56b8435e3c848df8fe6eb547f675380";
		_proof[5] = hex"f90211a07e191b84b2adb410842264d8aa87ac6f42ffb48fe02ba0b451414b7e181ce094a04bb6e3bacdcbfc2dae1a9051460856308160ca4ffb83ea9ada26eb1c086b02efa0beafa9a7e0b2073100526355a341de7a1a839c7f7322a594bdc9ed4d73d72283a0aeeb5d57c5a1502f64e8251dc855f75ab35b0ffcc6f86ee1811e75a0211866bfa060ab5df974581559a2ea810b9cb6e2fad6f3e153382228eef2d7f28cf8b07c23a002a0e92ee3563b82b3ab549ecfa5ebd413d04368d93744cddb1ec00a93129360a0a7dc512858655de4d0f5a33788a3c1faefd19854f006c626cb78ed86788ab4cba01f82dccb38b6497f0b906e7f25ef3e5aa404a0752f4483198bf5a54281e66933a00e45598cd602aa8362c7f48f839f94357da2d935158724d9bafc5abe131e745da097934d75e361d115ea93e2fdc0c91a54d59414f0daa2ac1991b6651ae6571f9ca009abf1666d7d9202849314692d5ce1e51e5629727701044b37532ab3f9be50c0a0dfb90b192bdf077fa61986060a35fc3fc345e5296673730e5432015db80681bba058ea9466450f42b25cc3298911ebeb081b6bc73f3c414f0d36244d331cc18c5da0f6a49ad3d72bf66720b055e7c11fc67aab1acb79dd8e67a35be70303ad4c83a9a06ef38fec665b8eb25934622af1112b9a9d52408c94d2c0124d6e24b7ff4296c0a05561c1768cfdb1a08408a8c691fd8ebf56b70586392dc6d94a4e9ddc6100f89a80";
		_proof[6] = hex"f8b1a02a85b6c4adf828a068d39f7bf4115a4544ebf32e007d63957a28ee21eb8dcd57a0344f34e01710ba897da06172844f373b281598b859086cf00c546594b955b870808080a0525e7dd1bf391cf7df9ffaaa07093363a2c7a1c7d467d01403e368bd8c1f4e5680808080808080a012fef841d5b1eac87af5ce5ec36569f9dad5faa7d7267eb6ce8ae07b37707b65a0eaa19d1cfff27bec6c33be3d7146bb970f70897905c5e0c9c50f90cf7fc075638080";
		_proof[7] = hex"f8719d3da65bd257638cf8cf09b8238888947cc3c0bea2aa2cc3f1c4ac7a3002b851f84f018b0367eb2a3e118b3df88693a0c4374dcfc4fbeff89d788125ced0c4bf18e802d191f7d18b4728179b57f4b666a0d0a06b12ac47863b5c7be4185c2deaad1c61557033f56c7d4ea74429cbb25e23";

		RLPReader.RLPItem[] memory proof = new RLPReader.RLPItem[](8);
		for (uint256 i = 0; i < 8; i++) {
			proof[i] = RLPReader.toRlpItem(_proof[i]);
		}

		// bytes memory acctRlpBytes = MerklePatriciaProofVerifier.extractProofValue(
		// 	stateRootHash,
		// 	abi.encodePacked(addressHash),
		// 	proof
		// );
	}

	function testStorageProof() public view {
		uint256 mappingSlot = 0;
		address key = 0x7B73644935b8e68019aC6356c40661E1bc315860;
		bytes32 slotHash = keccak256(abi.encodePacked(keccak256(abi.encode(key, mappingSlot))));
		bytes32 storageRootHash = bytes32(0x37b9e807ed032eb4478fe771fb89cf6be812686fb23f9e508086cd7733f125ad);

		bytes[] memory _proof = new bytes[](6);
		_proof[0] = hex"f90211a062413e018b028c02bb8dcd11b24cbdc75b3bfac38a858326413be726226b0e18a0051b9e59d98de54f85fcfee4dd674a1f326857827f02bd51a2ca2f99aaa52af6a048fe65753113f8addd576eeda745836b07eaff740ab565f1e9f8d784cfe9f96aa0a1f1ca355742d4adc8d6b8a85cac9e4774d23e3befa62a8b0346a9d3f61258c8a084094d9c65f5af4a972c87fa63fd6700bf6fd4bc42ab3d5406a81c1a239c720fa0f2b2b01ea2c50ae559910afcaca727953920586bd334ee535b36ba451b208b6fa024392967a19a0c7d5df81fd6458f13217a0a25971961108667798753f87acbe3a026b172495ef50885945495ee5b3e95bea260003d319c1f49972d75b418471ed0a056a7c9d1f6c022b71cc0defbefd9e9948ea128f8b2c82841fe03e0e0e5e0741da0178c95a554178ab45096defc7a3a0f394a7d2cc561e3762b8cdf243e42257dd9a05d855eb690571d4886a046c7f0e1341f1f1e267054e1e3f95c9751d2dd97a35aa0785c0dbef1bca15b00c5f6f2448df0200a3e04aa53e9f27d18d8ce1b94a3611ea05445ef66c31d890ebca2fce5e4d71942a1bb3419439c7690a585ef80bb79916aa0e8cb274c88c4075da1335c7be202775bd92701ed49a0e8d78dc603e174f96900a07ab247d76f7815119e8a4eded40d47e53d6f7a22c22f0363ba3248b65450577ba08c52d5d9601048d004bcf62c448f459c7a319a4dcbca456c6a81d04a584547b080";
		_proof[1] = hex"f90211a0ed756a26545d2f535b11b78bd554460b5f7b523caffa80ceb96b45aa6620fc5ea0cf92d2f2ada4f36ccead36c5d2c1cf5d9d1ffc3fbf1190db3fc3799ccb8bcf1ca0ede56f4bfdc06afa0a34d7001108008d026e64a8a52a87d9ac5f7307bb610c0ea0220832cb97ae5855ac67cb37b8d6a65c22243df71722e0faac0264964c8312f2a0ddd5bb21de50f5532b4bec7ad4692c1b8ab91d5e120886110d420c542e321934a0a6442048bb30cafa089b2765ef3664dda1d635d9f34eec5505b98f9fab8eb88da03f1dbe631c2ee6e34426fe174ded708729e82b492491e668d1f24cac9a304c4da0960862469cc9ab3425bed5d5a6148d151ac1d55c61f535fe15177f91b9e3857fa0ab983a810a86b895df05a79f3159dcc51c9ffdadbcfe758c29cae1c5774643b2a055c48a614422fb1aaaaa2f4b24a093d18e1ca662b3b4ebce1b504a5f26783415a0681e4cb1e34540ff360a13c7e2ef563b7d2b1ee1003540acf4aba6c23e4512d0a04db2462591bef4920d6bd40b725699c61a419c49ddfaba93606255580b64f9fda0b6a5965d7a76862e49297a4df7723889cf31dc06540595cca69ddda0200d685ca0cb60ab1e81b82f88ee845221d8419aa7107ab4a1e19b0aa2fb0928439ce024dda07532913cff4dbc76901cdae4b95b4132863881849efcbb6fa3f4e5ed5f15ecbea09eef8c9710fb5c47f1aaeebd27363887861e66f5d951c321fc1d5ebf014284c780";
		_proof[2] = hex"f90211a076eaa93f00e8ff2311d8f12653e6ee91eb709ba771dc2aaac0a66285185bda1ca0d945450215cc7d069027cd963e0a0b81fc11556fe1024995d03e38d1bdfa5d5ea09711d2900e1112121c2a88d6e57ee6184f08917aac055102f21d7bfa33971438a0671bc7bec71a989467243d993724cb60e973f0c39ae49888cbe299d504d1ea0da0fc8d8e5b36f650f2aa2ea2ed1826aa1548e97a3edd9a6b6d6b592aedb891e0eea0e1784f3b909143ecad223054d97f2a85623d1bc59162a65c06d9970a599830faa08f0bae3877d52d34f368ffa7d090f06bd44ea0cb235e946ee8c1181eae2ceca4a092ec5dfecc814afecfc7f5c018df0a73cb4f5ce67378ebaa60b8653300bacdc5a0f70b778916265e42c142f30b6ac4345abecfab9f30ee466a2853940bcfaa5766a0204f28999f24179d7a1d189f46add0339d01b385dd989e3c001e4516525c77e6a07c3b1895ff07e729effab774687e6c7c63266f0f1b245c77bcc1ea79182be270a045ea0d2afa91bc8af33aebbd0735829a03e44a918b6f477f448ca29c6b5cd02ea039707d01369b7c81253645d8c9307665152c39a0428d70ec7cbfffb6af6a21e4a046528614aaf720d9db5515b7eca112ae5d0815c9cf540cd261dcdbec36255840a0ab40b39110acc402b9e7b4973f03db0bde94f32b9a3e3909590dd79c5bb19800a060cd50d2e823144332f8133bc2e432aee1e30ab4e30c843481d7d44ae991e90580";
		_proof[3] = hex"f90211a099115c90165b080e092f3c81c4f712bd8be88e0b48f41340636c7117f1a64985a024ef83dc61c51880837032ee303b85dfa16f8e108b38557fd6bdc8e44a2c8abea0b85abde98deea64e6ce453bc0779d5bda461777b84489c773f384c290491fb8ba0e78b9c512549ff2fe76adb5d23dbf74266a9cddc78f4a41ef9a80533aab90db4a08d5b7794ceceeddaa47f35ab821e82f1a19e68b7963275ba589e3b85bc831cf4a04969018f11f143355f45cc21b698250387c0d1ddff4a620545b765105ab5c04da077bdaa4abde9a836b598a372632bde933ec534bc3061c8c185fab7b25dd7f365a01eb64c972c1566a6d399009f086dd5b24bf519d98869b09292da1339703a7743a0458f7d61af5caf49b72a09753bb491882e4bd6beab877929852990d22d793b1aa0387b6e7ef0bb5eb455a5406bc319ccc3fcf372085760d96736d6495a32fb5342a04880ab8d90b663da20549aede0edc91c3acdb74d4dcdf47d4098f7796fa2b6eba0ed1e49fe009eace09cc706db18a62a080c424440886db63e66e93d990767b4e1a00e9535be84cc10a09c58f720ad2c3bc18936537468dd9131fdb510078615cf39a0f5b843975aa5d699052fcab071f595819f1708f15f8ce5b9f1baeacfd72d24e9a05468d53294e1f91ecf931aa804fba0d451df049c481ade2e437e9ee657199791a0944fe238c4af2689f809d6ab267928aaee6ed77b86eab1535d778aa06067e1ea80";
		_proof[4] = hex"f891808080a005ef481b8f20b78cf2e5ffe3abc0d769f48b4922536a9e3fa8750d9b84991112a010980c42f01028721d18ab051d8413589ba9e7ac22fec74e7f7cfc830380bcc380808080808080a0a2ed44c9a14d827b37b0794a36a2e754f1169a3797398d5bdbcdee3a22751ed080a0b637a417499de9fd48110852214fc76db9c1eed123c7e5ff59b80442ac91cd418080";
		_proof[5] = hex"ee9e34342a34cb0cd65156e288545f6d28af3d1a56fee48fc05a591ff701c8f98e8df69c25161c8c1ccf44a7696e0c";

		RLPReader.RLPItem[] memory proof = new RLPReader.RLPItem[](6);
		for (uint256 i = 0; i < 6; i++) {
			proof[i] = RLPReader.toRlpItem(_proof[i]);
		}

		bytes memory acctRlpBytes = MerklePatriciaProofVerifier.extractProofValue(
			storageRootHash,
			abi.encodePacked(slotHash),
			proof
		);
		require(acctRlpBytes.length != 0);
	}

	function testReceiptProof() public view {
		// This costs 102k gas
        bytes32 receiptsRoot = 0x05911bffdb32343df6d8af53971ade6b8959e1b06ad994715a8080524a2875d2;
	 	bytes memory key = hex"28";
        bytes[] memory proof = new bytes[](3);
        proof[0] = hex'f8f1a0f90859a9e586a4c8e66aa9f1d32a4931f1154c77ec712fc9ecc99a4ed776326ea06a557db722597a9aeda7c98bb7ffe686142f7ac18cc9c8dfb25d22031bc5f6b0a06c00bc782e736cf97c33ad6d7e6bd2fd39fa279fee4bc305a9a117865942a2d1a0a8748472369eb2aa13896d4affa91a3a9228164479c2bd8031d386e270b0b302a084893bd2913ed19cf8c3f6dff9ae3b185da5d48d8befacabcb3a0c687b972c79a09eb3558591217617199301798ae54f7a68d8a9d40f71e69ee9771be63ab3cd138080a0c1ae84c085bcad8ac7da99930f744eb6299213b996578e541639a647aed4952f8080808080808080';
        proof[1] = hex'f90211a01ae3959b059ad75342767a69756a715eaa78a197e8e50f05ca72d0a30c124623a0c506f11780d11f404615fd9b8d6469b894c864faee83e65dfe53432cbd8738c2a0edcfb8698c0c16908eddeeec015dc13d411567425ba8cca866029ce76c338ccea0ae070ce274ca2f45e789eb6b3ce73ff75862f1d1a486b89fd40c9af46ec5ecd0a0e25336ce8790d2e819346a186f64c7b6e5149c296d70974fe0e5590506274a0fa038fca8cb5118c4752c08aab2773377599fd3e903ebd095a6a4fd57cb54bb51cca018424f39f11e17dff48ed7a2ce79aa5534d0baf80e4243ed49afc09993d3e6b5a06034cd832ee0f9afa604e52dd36194afcfb490d6e0eec948279f13ca70f3f7a3a01de767efc90eaf623ba1d5e0590cffcdca7a46309d503859f6244e9b32c05cd7a06b1d893b5d8c89e8a4fdc7f78ef58330423581bc22d1475d0cc412b242fc3f4aa02e0fa09c622d4501e090b99bba2d6f3e73e1aba6c9d10c7fefe7d30387d6fee7a0a79b0390f680dd07adc82cec55240eab8da8393c53a291b7049b1b456315a210a01db287df72ab4378d8ad8176457d088f588611eff06b827b3c0d707b9f9228cca05f9c098db814b8531ed8ce9dc05551aa2731b31753af975265ea2eefd7d71c9ca02d960af158338798d676da70e5c93f08ab1364128e31c32b3ad748bd30f37e73a06b767cebaba781d29c0e85ebfe2a9318a44e8408cda2bfef3e299f9b08b6842d80';
        proof[2] = hex'f9050c20b9050802f905040184016ebfaeb901004000000000010000000000000100000000000200000000000000000000000000000080000000800000000000000000002000000000000000000000000020000000000000000000000000000c800000020000000000000000000000000000000040000000000000000000000000000200000000000000002000000010800000000000000000000000000000080000000000001080000000000000000000000100020000000004000000000000020000000000000000000000000000000000000000000002000000000001000001000020000000000000000000000000000000000018000000000000004000000000000000200000000000000400000000000000f903f8f89b9445cd94330ac3aea42cc21cf9315b745e27e768bdf863a08c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925a0000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05a0000000000000000000000000e8a7f02499402a72532669fdcc8d70674351b23da00000000000000000000000000000000000000000000000000000000000000000f89b9445cd94330ac3aea42cc21cf9315b745e27e768bdf863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05a0000000000000000000000000e8a7f02499402a72532669fdcc8d70674351b23da00000000000000000000000000000000000000000000000000000000000000002f901fd9468787ab0ca5a4a8cc82177b4e4f206765ce39956f863a069fba49bf5354b0f1c560ef32d7525874d05e65452e997b5556a9dedb5d7576fa0000000000000000000000000000000000000000000000000000000000000003aa03945f27c4f49fbcfa635ea64f6996759b49f07c8e1912494bce5ad187f99d53bb9018000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000e8a7f02499402a72532669fdcc8d70674351b23d0000000000000000000000005ae47c1ee4bef58291574dad5e11aece2f79e98b0000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000c35000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05000000000000000000000000000000000000000000000000000000000000000200000000000000000000000045cd94330ac3aea42cc21cf9315b745e27e768bdf8bc94e8a7f02499402a72532669fdcc8d70674351b23df863a04e0b8b96097e818e136165437b47119a1f95ecfae8c068a60bd0a1394b238ef4a0000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05a0000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05b840000000000000000000000000000000000000000000000000000000000000000200000000000000000000000045cd94330ac3aea42cc21cf9315b745e27e768bd';
		RLPReader.RLPItem[] memory proofAsRLP = new RLPReader.RLPItem[](proof.length);
		for (uint256 i = 0; i < proof.length; i++) {
			proofAsRLP[i] = RLPReader.toRlpItem(proof[i]);
		}
        bytes memory value = MerklePatriciaProofVerifier.extractProofValue(
            receiptsRoot,
            key,
            proofAsRLP
        );
        RLPReader.RLPItem memory valueAsItem = value.toRlpItem();
        if (!valueAsItem.isList()) {
            // TODO: why do we do this ...
            valueAsItem.memPtr++;
            valueAsItem.len--;
        }
        RLPReader.RLPItem[] memory valueAsList = valueAsItem.toList();
        RLPReader.RLPItem[] memory logs = valueAsList[3].toList();
        uint256 logIndex = 2;
        RLPReader.RLPItem[] memory relevantLog = logs[logIndex].toList();
        console.logAddress(relevantLog[0].toAddress()); // this is the address of the emitting contract
        RLPReader.RLPItem[] memory topics = relevantLog[1].toList();
        console.logBytes(topics[0].toBytes()); // hash of the event signature
        console.logBytes(topics[1].toBytes()); // nonce
        console.logBytes(topics[2].toBytes()); // messageRoot
        require(bytes32(topics[0].toUintStrict()) == keccak256("SentMessage(uint256,bytes32,bytes)"), "TruslessAMB: different event signature expected");
    }
}